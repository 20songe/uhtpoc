<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercise 2 Guide</title>
  <link rel="stylesheet" href="../assets/css/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="container topbar__inner">
      <div class="brand">
        <img class="brand__mark" src="../assets/images/logo.svg" alt="POC Hub"/>
        <div class="brand__text">
          <div class="brand__title">POC Hub</div>
          <div class="brand__subtitle">InterSystems IRIS for Health • Exercise 2</div>
        </div>
      </div>

      <nav class="quicklinks" aria-label="Quick links">
        <a class="chip" href="../index.html">Back to Home</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- HERO (matches installation guide structure) -->
    <section class="hero">
      <h1>POC Exercise 2: FHIR-to-SQL</h1>
      <p>
        Use the instructions on this page to complete the exercise. The checklists can track progress (saved in browser).
      </p>
    </section>

    <!-- OVERVIEW / SUCCESS -->
    <section class="section">
      <div class="section__header">
        <h2>Exercise Overview</h2>
        <p class="muted">Unity Health Toronto is seeking to ingest FHIR resources directly into SQL tables stored in IRIS that can be exposed externally for downstream analytics and research.</p>
        <br/>
        <p class="muted">In this exercise, we will demonstrate how IRIS simplifies FHIR server creation and efficiently maps FHIR data into a SQL table. We will leverage the same built-in IRIS tools from Exercise One to create this FHIR-to-SQL pipeline. We will examine the data through a combination of IRIS tools and external tools (SQL client and REST client).
          </p>
        <br/>
      </div>

      <details class="details details--accent" >
        <summary>Measures of Success</summary>
        <div class="details__content">
          <ul class="bullets">
            <li>Successful ingestion and transformation of FHIR R4 Patient Resources into a SQL table.</li>
            <li>Successful access to the tabular data</li>
            <li>Successful data query through a FHIR endpoint.</li>
          </ul>
          <p class="muted" style="margin-top:10px;">
            Validation of this success will be accomplished using tools available through IRIS (Visual Trace, SQL Engine), an external SQL database (PostgreSQL), and an external REST client (Postman) at the end of this exercise
          </p>
        </div>
      </details>
    </section>

    <!-- PRE-REQUISITES -->
    <section id="prereqs" class="section">
      <div class="section__header">
        <h2>Pre-requisites</h2>
        <p class="muted">Complete these prerequisites before building the interoperability pipeline.</p>
      </div>

      <details class="details details--accent">
        <summary>Pre-requisites</summary>
        <br/>

        <form class="checklist" data-checklist-id="exercise-1-prereqs">

          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span>
              <strong>1.</strong> Install Postman on your local machine (outside of the Google VM).</code></pre>
            </span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
        </form>
      </details>
    </section>

    <!-- FHIR Endpoint Setup -->
    <section id="fhir" class="section">
      <div class="section__header">
        <h2>FHIR Server Setup</h2>
        <p class="muted">Configure a new interoperability-enabled FHIR server and endpoint.</p>
      </div>

      <details class="details details--accent">
        <summary>FHIR Server Configuration</summary>

        <div class="details__content">
          <p class="muted">We will configure a new FHIR server and its corresponding endpoint in your namespace.</p>
        </div>

        <form class="checklist" data-checklist-id="exercise-1-sql-transformation">
          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span>
              <strong>1.</strong> From the homepage of the Management Portal, select your namespace (i.e. <code>UNITY</code>).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>2.</strong> On the left-side menu, click <code>Health.</code> This pulls up the page for healthcare tool management, such as FHIR server configuration.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>3.</strong> From the Health page, click <code>FHIR Server Management.</code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>4.</strong> Click the <code>Add new server</code> button.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>5.</strong> Configure as follows:
              <ul class="bullets">
                <li><strong>Namespace:</strong> &lt;Select your namespace (i.e. <code>UNITY</code>)&gt;</li>
                <li><strong>Name:</strong> &lt;Name of your namespace (i.e. <code>UNITY</code>, but can be anything)&gt;</li>
                <li><strong>FHIR Version:</strong> FHIR R4</li>
                <li><strong>URL:</strong> &lt;Keep the default (i.e. <code>/csp/healthshare/dev/fhir/r4</code>)&gt;</li>
                <li><strong>Custom Packages:</strong> hl7.fhir.us.core@3.1.0</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>6.</strong> Click <code>Create</code>. The FHIR server and endpoint creation may take a couple of minutes.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>7.</strong> Once FHIR server and endpoint creation is done, click the <code>Home</code> link in the top right corner to return to the Management Portal Home page.
            </span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
          </form>
      </details>

      <details class="details details--accent">
        <summary>FHIR Interoperability Configuration</summary>

        <div class="details__content">
          <p class="muted">We will create interoperability components that accept FHIR requests and pass all FHIR requests and responses through the interoperability production created in Exercise 1.</p>
        </div>

        <form class="checklist" data-checklist-id="exercise-1-sql-transformation">
          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span>
              <strong>1.</strong> On the Management Portal home page, make sure we are in your POC namespace (i.e. <code>UNITY</code>).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span>
              <strong>2.</strong> Navigate to Interoperability → Configure → Production. This should open the production we built last week.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span>
              <strong>3.</strong> Create a new business service with the following configurations (on the <code>All Services</code> tab):
              <ul class="bullets">
                <li><strong>Service Class:</strong> HS.FHIRServer.Interop.Server</li>
                <li><strong>Service Name:</strong> FHIRIn</li>
                <li><strong>Display Category:</strong> Exercise 2 (you will likely need to type this in)</li>
                <li><strong>Enable Now:</strong> Checked</li>
                <li>Click <code>OK.</code></li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>4.</strong> Create a new business operation with the following configurations (on the <code>All Services</code>):
              <ul class="bullets">
                <li><strong>Operation Class:</strong> HS.FHIRServer.Interop.Operation</li>
                <li><strong>Operation Name:</strong> FHIROut</li>
                <li><strong>Display Category:</strong> Exercise 2</li>
                <li><strong>Enable Now:</strong> checked</li>
                <li>Click <code>OK.</code></li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>5.</strong> Create a new business operation with the following configurations (on the <code>All Services</code>):
              <ul class="bullets">
                <li><strong>Operation Class:</strong> HS.FHIRServer.Interop.Operation</li>
                <li><strong>Operation Name:</strong> FHIROut</li>
                <li><strong>Display Category:</strong> Exercise 2</li>
                <li><strong>Enable Now:</strong> checked</li>
                <li>Click <code>OK.</code></li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>6.</strong> Click on the <code>FHIRIn</code> business service we created previously. In the settings panel, configure the following under the Basic Settings section:
              <ul class="bullets">
                <li><strong>Target Config Name:</strong> FHIROut</li>
                <li>Click Apply at the top of the settings panel to save this setting.</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>7.</strong> Return to the home page of the Management Portal.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>8.</strong> Click <code>Health.</code> Then, on the Health page, click <code>FHIR Server Management.</code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>9.</strong> Click the three horizontal bars on the top right of the card for your FHIR server/endpoint (i.e. UNITY).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>10.</strong> On the menu that pops up, click <code>Edit</code>.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>11.</strong> Expand the <code>FHIR Server Service Configuration</code> setting.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3"/>
            <span>
              <strong>12.</strong> Under <code>Service Config Name</code>, use the dropdown to select <code>FHIRIn.</code> Click <code>Save</code>.
            </span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
          </form>
      </details>

      <details class="details details--accent">
        <summary>(Optional) Test the New FHIR Endpoint</summary>

        <div class="details__content">
          <p class="muted">We will practice making FHIR REST calls to the IRIS FHIR Server through Postman.</p>
        </div>

        <form class="checklist" data-checklist-id="exercise-1-sql-transformation">
          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>1.</strong> On the FHIR Server Management page, copy the URL from your FHIR endpoint's card (i.e. /csp/healthshare/unity/fhir/r4).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>2.</strong> If the production in your namespace is not yet running, go to the Home page and then in your namespace, navigate to Interoperability → Configure → Production. Click <code>Start.</code>
            </span>
          </label>

          <form class="checklist" data-checklist-id="exercise-1-sql-transformation">
            <label class="checklist__item">
              <input type="checkbox" data-step="2" />
              <span>
                <strong>3.</strong> Within Postman, create a new GET request.
              </span>
            </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>4.</strong> For the URL, enter: <pre><code>http://&lt;hostname&gt;/irishealth/&lt;URL copied in step 1&gt;/metadata</code></pre>
              
              <br/>
              Run the request. You should see a capability statement that displays valid interactions and operations for the IRIS FHIR Server.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>5.</strong> Change the Postman request method to <code>POST</code>.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>6.</strong> For the URL, enter: 
              <pre><code>http://&lt;hostname&gt;/irishealth/&lt;URL copied in step 1&gt;/Patient</code></pre>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>7.</strong> In Postman, navigate to the <code>Authorization</code> tab. Select <code>Basic Auth</code> for the Auth Type. Enter your credentials for logging into IRIS (such as SuperUser).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>8.</strong> Run the request. You should see a response saying no Patients are found.
            </span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
        </form>

      </details>

    </section>


    <!-- FHIR-to-SQL DATA TRANSFORMATION -->
    <section id="dtl" class="section">
      <div class="section__header">
        <h2>Build a FHIR-to-SQL Data Transformation</h2>
        <p class="muted">Create a data transformation and a business process for transforming from a FHIR Patient resource into the SQL tables from Exercise 1.</p>
      </div>

      <details class="details details--accent">
        <summary>Build a FHIR-to-SQL Data Transformation</summary>

        <div class="details__content">
          <p class="muted">We will practice creating a rule router and data transformation for inbound FHIR data from scratch.</p>
        </div>

        <form class="checklist" data-checklist-id="exercise-2-sql-transformation">
        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>1.</strong> From the Home page of the Management Portal, navigate to Interoperability → Build → Data Transformations.
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>2.</strong> In the top left corner, click <code>New.</code> Configure the following:
            <ul class="bullets">
              <li><strong>Package:</strong> UNITYPKG.DTL (this might be different depending on your namespace)</li>
              <li><strong>Name:</strong> FHIRtoSQLPatientSubtransform</li>
              <li><strong>Source Type:</strong>
              <ul class="bullets">
                <li>Click the magnifying glass next to <code>Source Class</code> text box.</li>
                <li>In the pop-up, select on the leftmost pane: <code>All Non-System Classes</code></li>
                <li>Select: HS → FHIR → DTL → vR4 → Model → Resource → Patient</li>
              </ul></li>
              <li><strong>Target Type:</strong>
              <ul class="bullets">
                <li>Click the magnifing glass next to <code>Target Class</code> text box.</li>
                <li>In the pop-up, select on the leftmost pane: <code>Persistent Classes</code></li>
                <li>Select: uhtpoc → Patient</li>
                </ul>
              </li>

              <li>Click <code>OK</code></li>.
            </ul>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>3.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.mrn</code></pre></li>
              <li><strong>Value:</strong> <pre><code>source.identifier.(1).id</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>4.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.firstname</code></pre></li>
              <li><strong>Value:</strong> <pre><code>source.name.(1).given.(1)</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>5.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.lastname</code></pre></li>
              <li><strong>Value:</strong> <pre><code>source.name.(1).family</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>6.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.dateofbirth</code></pre></li>
              <li><strong>Value:</strong> <pre><code>$System.SQL.TODATE(source.birthDate,"YYYY-MM-DD")</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>7.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.gender</code></pre></li>
              <li><strong>Value:</strong> <pre><code>source.gender</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>8.</strong> Create a <code>set</code> action with the following configuration:
            <ul class="bullets">
              <li><strong>Property:</strong> <pre><code>target.phone</code></pre></li>
              <li><strong>Value:</strong> <pre><code>source.contact.(1).telecom.(1).value</code></pre></li>
            </ul>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>9.</strong> Create a <code>sql</code> action with the following SQL statement:
            <br/>
            
            <pre><code>INSERT INTO uhtpoc.Patient 
(mrn, first_name, last_name, date_of_birth, gender, phone) 
VALUES (target.mrn, 
target.firstname, 
target.lastname, 
target.dateofbirth, 
target.gender, 
target.phone)</code></pre>
          </code>
          </span>
        </label>

        <label class="checklist__item">
          <input type="checkbox" data-step="6" />
          <span><strong>10.</strong> Click <code>Compile</code>.
          </span>
        </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span>
              <strong>11.</strong> In the top left corner, click <code>New</code>. Configure the following:
              <ul class="bullets">
                <li><strong>Package:</strong> UNITYPKG.DTL (this might be different depending on your namespace)</li>
                <li><strong>Name:</strong> FHIRtoSQL</li>
                <li><strong>Source Type:</strong>
                <ul class="bullets">
                  <li>Click the magnifying glass next to <code>Source Class</code> text box.</li>
                  <li>In the pop-up, select on the leftmost pane: <code>All Non-System Classes</code></li>
                  <li>Select: HS → FHIRServer → Interop → Request</li>
                </ul></li>
                <li><strong>Target Type:</strong>
                <ul class="bullets">
                  <li>Click the magnifying glass next to <code>Target Class</code> text box.</li>
                  <li>In the pop-up, select on the leftmost pane: <code>Persistent Classes</code></li>
                  <li>Select: uhtpoc → Patient</li>
                  </ul>
                </li>
  
                <li>Click <code>OK</code></li>.
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>12.</strong> Create a <code>set</code> action with the following configuration:
              <ul class="bullets">
                <li><strong>Property:</strong> <pre><code>resourceStream</code></pre></li>
                <li><strong>Value:</strong> <pre><code>##class(HS.SDA3.QuickStream).%OpenId(source.QuickStreamId)</code></pre></li>
              </ul>
            </code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>13.</strong> Create a <code>set</code> action with the following configuration:
              <ul class="bullets">
                <li><strong>Property:</strong> <pre><code>resource</code></pre></li>
                <li><strong>Value:</strong> <pre><code>##class(HS.FHIR.DTL.vR4.Model.Resource.Patient).FromJSON(resourceStream,"vR4")</code></pre></li>
              </ul>
            </code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>14.</strong> Create a <code>subtransform</code> action with the following configuration:
              <ul class="bullets">
                <li><strong>Transform Class:</strong> <pre><code>UNITYPKG.DTL.FHIRtoSQLPatientSubtransform</code></pre></li>
                <li><strong>Source:</strong> <pre><code>resource</code></pre></li>
                <li><strong>Target:</strong> <pre><code>target</code></pre></li>
              </ul>
            </code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>15.</strong> Click on <code>Compile</code>.
            </code>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="4" />
            <span><strong>12.</strong> Create a new business process with the following configuration:
            <ul class="bullets">
              <li><strong>Business Process Class: </strong>EnsLib.MsgRouter.RoutingEngine</li>
              <li><strong>Auto-Create Rule:</strong> Checked</li>
              <li><strong>New Rule Package: </strong> UNITYPKG.Rule (the parent package might have a slightly different name like UNITY1PKG, depending on your namespace name)</li>
              <li><strong>Business Process Name: </strong>FHIRRouter</li>
              <li><strong>Display Category:</strong> Exercise 2</li>
              <li><strong>Enable Now:</strong> Checked</li>
              <li>Click <code>OK.</code></li>
            </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="5" />
            <span><strong>13.</strong> Click on your new message router. From the settings panel (Basic Settings), click the magnifying glass next to the <code>Business Rule Name</code> configuration to open the auto-created business rule.</span>
          </label>


          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>14.</strong>  Configure a new rule as follows:
              <ul class="bullets">
                <li><strong>Name:</strong> FHIRtoSQLPatient</li>
                <li><strong>Source:</strong> FHIRIn</li>
                <li><strong>Message Class:</strong> HS.FHIRServer.Interop.Request</li>
                <li>Click <code>OK.</code></li>
              </ul>
            </span>
          </label>


          <label class="checklist__item">
            <input type="checkbox" data-step="7" />
            <span><strong>15.</strong> Click <code>+condition</code> to add a new condition (for filtering based on message content).</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="8" />
            <span><strong>16.</strong> Double click on the new condition and configure it as follows:
            <ul class="bullets">
              <li><strong>Value:</strong> 1</li>
              <li>Click <code>OK</code>.</li>
            </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="8" />
            <span><strong>17.</strong> Click on <code>then</code> or <code>actions</code>. Then select <code>+send</code>.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="9" />
            <span><strong>18.</strong> Double click the send action and configure as follows:
            <ul class="bullets">
              <li><strong>Value:</strong> PostgreSQLPatient</li>
              <li><strong>Transform:</strong> UNITYPKG.DTL.FHIRtoSQL</li>
            </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="10" />
            <span><strong>19.</strong> Click on <code>then</code> or <code>actions</code>. Then select <code>+send</code> to add a second send action.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="9" />
            <span><strong>20.</strong> Double click the newest send action and configure as follows:
            <ul class="bullets">
              <li><strong>Value:</strong> FHIROut</li>
              <li><strong>Transform:</strong> &lt;Leave this blank&gt;</li>
            </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="10" />
            <span><strong>21.</strong> Click compile.</span>
          </label>
          

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
        </form>
      </details>
    </section>

    <!-- HL7v2 BUSINESS RULES AND ROUTING -->
    <section id="routing" class="section">
      <div class="section__header">
        <h2>FHIR Business Rules and Routing</h2>
        <p class="muted">Configure a routing engine and routing rules for the FHIR data.</p>
      </div>

      <details class="details details--accent">
        <summary>HL7v2 Business Rules and Routing</summary>
        <br/>

        <div class="details__content">
          <p class="muted">
            We will configure data ingestion, business rules, and routing for our HL7v2 messages.
          </p>
        </div>

        <form class="checklist" data-checklist-id="exercise-1-routing">
          <label class="checklist__item">
            <input type="checkbox" data-step="4" />
            <span><strong>1.</strong> From the home page, navigate to Interoperability → Configure → Production.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="5" />
            <span><strong>2.</strong> We will create a new business service to ingest HL7 files. This simulates an HL7 TCP connection, which is typical for real HL7v2 interoperability productions. Click on the small plus icon next to Services at the top of the production page.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/25-service.png" alt="Create HL7 service" />
                </div>
              </details>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>4.</strong> In the pop-up, select the HL7 Input tab. Select File. Configure the following:
            <ul class="bullets">
              <li>HL7 Service Name: HL7FileIn</li>
              <li>Display Category: Exercise 1</li>
              <li>Enable Now: checked</li>
              <li>HL7 Service Target: Choose From List</li>
              <li>Target: HL7Router</li>
              <li>HL7 Schema Category: 2.5.1</li>
              <li>File Path: /isc/MessageIn/HL7/</li>
            </ul>
            
            Click OK.

            <details class="hint">
              <summary>Hint</summary>
              <div class="hint__content">
                <img src="../assets/images/exercise1/26-business-service-wizard.png" alt="Create HL7 service" />
              </div>
            </details>
          </span>
          </label>

          <div class="details__content">
            <p class="muted">
              Next, we'll edit the business rule to apply the transformations we built to our message.
            </p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="14" />
            <span><strong>4.</strong> Under the Processes section in the center of the production configuration page, click on the existing HL7Router component.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="15" />
            <span><strong>5.</strong> In the settings panel on the right, scroll to Basic Settings. Click the magnifying glass next to the Business Rule Name setting. This opens the rule editor.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="16" />
            <span><strong>6.</strong> Double click on the rule. In the pop-up, configure the following:
              <ul class="bullets">
                <li>Name: HL7toSQLPatient</li>
                <li>Source: HL7FileIn</li>
                <li>Schema Category: 2.5.1</li>
                <li>Document Name: ADT_A01, ADT_A02, ADT_A03</li>
              </ul>

              Click OK.

              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/27-rule-config.png" alt="Rule configuration" />
                </div>
              </details>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="22" />
            <span><strong>7.</strong> Click on the +condition button to the right of the rule.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/28-condition.png" alt="Condition" />
                </div>
              </details></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="23" />
            <span><strong>8.</strong> Double click on the newly added condition item.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/29-condition.png" alt="Condition" />
                </div>
              </details></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="24" />
            <span><strong>8.</strong> In the pop-up, set Value to 
              
              <pre><code>HL7.{PID:PatientIdentifierList(1).IDNumber} StartsWith "123" </code></pre>
              
              Click OK.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/30-edit-expression.png" alt="Condition" />
                </div>
              </details></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="25" />
            <span><strong>9.</strong> Click on the <code>then</code> or the <code>actions</code> button inside the rule.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/31-then-action.png" alt="Condition" />
                </div>
              </details></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="26" />
            <span><strong>10.</strong> Click on the +send button to the right of the new then action item.
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/32-send.png" alt="Condition" />
                </div>
              </details></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="27" />
            <span><strong>11.</strong> Double click on the newly added send action.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="28" />
            <span><strong>12.</strong> In the Edit Send pop-up, configure the following:
              <ul class="bullets">
                <li>Target: <pre><code>PostgreSQLPatient</code></pre></li>
                <li>Transform: <pre><code>UNITYPKG.DTL.ADTtoSQLPatient</code></pre></li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="31" />
            <span><strong>13.</strong> Click Compile.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="32" />
            <span><strong>14.</strong> Next, we'll add a second rule to work with the encounter data. Click on the rule and then click on the +rule button.
            
            
              <details class="hint">
                <summary>Hint</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/33-rule.png" alt="Condition" />
                </div>
              </details>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="33" />
            <span><strong>15.</strong> Double click on the new rule to edit it. In the pop-up, configure the following:
            <ul class="bullets">
              <li>Name: HL7toSQLEncounter</li>
              <li>Source: HL7FileIn</li>
              <li>Doc Category: 2.5.1</li>
              <li>Doc Name: ADT_A01, ADT_A02, ADT_A03</li>
            </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="38" />
            <span><strong>16.</strong> Click on the +condition button next to the new rule.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="39" />
            <span><strong>17.</strong> Double click on the new condition to edit it.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="40" />
            <span><strong>18.</strong> In the Value text box, enter 1. Click OK.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="41" />
            <span><strong>19.</strong> Click on the <code>then</code> or <code>actions</code> button inside the rule to bring up additional actions we can add. Click the +send to the RIGHT of the new then action item.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="42" />
            <span><strong>20.</strong> Double click on the newly added send action.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="43" />
            <span><strong>21.</strong> In the Edit Send pop-up, configure the following:
              <ul class="bullets">
                <li>Target: PostgreSQLEncounter</li>
                <li>Transform: UNITYPKG.DTL.ADTtoSQLEncounter</li>
              </ul>

              Click Compile.
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="47" />
            <span><strong>22.</strong> Compile the transformation.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="47" />
            <span><strong>23.</strong> Return to the home page.</span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
        </form>
      </details>
    </section>

    <!-- CONFIGURE POSTGRESQL EXPORT -->
    <section id="pgexport" class="section">
      <div class="section__header">
        <h2>Configure PostgreSQL Export</h2>
        <p class="muted">Enable external language servers and configure SQL Gateway + production operations.</p>
      </div>

      <details class="details details--accent">
        <summary>Configure PostgreSQL Export</summary>
        <br/>

        <div class="details__content">
          <p class="muted">In this section, we will set up IRIS for exporting SQL data to a PostgreSQL database on the Google VM. First, we will make sure the JDBC Server and Java language servers are running so that we can make a JDBC connection between IRIS and PostgreSQL.</p>
        </div>

        <form class="checklist" data-checklist-id="exercise-1-routing">

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <span><strong>1. </strong>From the home page, navigate to System Administration → Configuration → Connectivity → External Language Servers.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span><strong>2. </strong>Click Start next to %JDBC Server if the server is not yet started. Click OK and wait for the server to start. Click Done when finished.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="4" />
            <span><strong>3. </strong>Click Start next to %Java Server if the server is not yet started. Click OK and wait for the server to start. Click Done when finished.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="5" />
            <span><strong>4. </strong>Write down the port for the %Java Server entry (you will need this in a later step).</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="6" />
            <span><strong>5. </strong>Return to the home page.</span>
          </label>

          <div class="details__content">
            <p class="muted">Next, we will set up the SQL Gateway in IRIS to connect to your PostgreSQL database.</p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="8" />
            <span><strong>6. </strong>From the home page, navigate to System Administration → Configuration → Connectivity → SQL Gateway Connections.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="9" />
            <span><strong>7. </strong>Click Create New Connection.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="10" />
            <span><strong>8. </strong>Configure the connection as follows:
              <ul class="bullets">
                <li>Type of connection: JDBC</li>
                <li>Connection name: postgresql</li>
                <li>User: superuser</li>
                <li>Password: &lt;your superuser password&gt;</li>
                <li>Driver name: org.postgresql.Driver</li>
                <li>URL: jdbc:postgresql://localhost:5432/uhtpoc</li>
                <li>Class path: /usr/share/java/postgresql-42.3.3.jar</li>
                <li>Click Test Connection to make sure your configuration is valid.</li>
                <li>Click Save.</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="20" />
            <span><strong>9. </strong>Return to the home page.</span>
          </label>

          <div class="details__content">
            <p class="muted">We will edit the interoperability production to work with these newly enabled components of IRIS for our PostgreSQL connection.</p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="22" />
            <span><strong>10. </strong>Return to the home page. Ensure you are in the <code>UNITY</code> namespace. Then f the home page, navigate to Interoperability → Configure → Production.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="23" />
            <span><strong>11. </strong>Under Services, click on JavaGatewayService. In the right-side settings panel, configure the following under Basic Settings:
              <ul class="bullets">
                <li>Enabled: check</li>
                <li>External Language Server Name: %Java Server</li>
                <li>Address: 127.0.0.1 (should be default)</li>
                <li>Port: &lt;port from step 4 earlier&gt;</li>
                <li>Click Apply at the top of the panel to save these settings.</li>
                </ul>

                <details class="hint">
                  <summary>Hint</summary>
                  <div class="hint__content">
                    <img src="../assets/images/exercise1/34-java-gateway.png" alt="Java Gateway config" />
                  </div>
                </details>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="29" />
            <span><strong>12. </strong>Under Operations, click on PostgreSQLPatient. In the right-side settings panel, configure the following under Basic Settings:

              <ul class="bullets">
                <li>Enabled: check</li>
                <li>DSN: postgresql (type this into the text box)</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="32" />
            <span><strong>13. </strong>Scroll down and under Connection Settings, configure the following:
            <ul class="bullets">
              <li>Java Gateway Service: JavaGatewayService</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="34" />
            <span><strong>14. </strong>Scroll down and under Data in the settings, configure the following:
              <ul class="bullets">
                <li>Query: <pre><code>INSERT INTO Patient (mrn, first_name, last_name, date_of_birth, gender, phone) VALUES (?, ?, ?, ?, ?, ?)</code></pre></li>
                <li>RequestClass: uthpoc.Patient</li>
              </ul>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="37" />
            <span><strong>15. </strong>Still in the Data section, we can configure the input parameters as follows:
            <ul class="bullets">
              <li>Input Parameters:
                <ul>
                  <li>Click the plus icon next to Add.</li>
                  <li>Click the Table icon (next to the red X).</li>
                  <li>In the popup, select *mrn from the dropdown.</li>
                  <li>Click OK.</li>
                  <li>Repeat steps i-iv for the rest of the parameters in the following order: *firstname, *lastname, *dateofbirth, *gender, *phone</li>
                </ul>
              </li>
              <li>Parameters' SQL data types: 
                <pre><code>SQL_VARCHAR,SQL_VARCHAR,SQL_VARCHAR,SQL_DATE,SQL_VARCHAR,SQL_VARCHAR</code></pre></li>

                <li>Click Apply at the top of the panel to save these settings.</li>
            </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="46" />
            <span><strong>16. </strong>Under Operations, click on PostgreSQLEncounter. In the right-side settings panel, configure the following under Basic Settings:
            <ul class="bullets">
              <li>Enabled: check</li>
              <li>DSN: postgresql</li>
              <li>All of the other settings should be configured for you. Feel free to verify the SQL query to make sure it is valid for the table you created in PostgreSQL.</li>
            </ul></span>
          </label>

          <div class="details__content">
            <p class="muted">You should have all the components necessary for export to PostgreSQL ready now. Time to test!</p>
          </div>
  

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
          
        </form>
      </details>
    </section>

    <!-- DATA INGESTION AND VALIDATION -->
    <section id="validate" class="section">
      <div class="section__header">
        <h2>Data Ingestion and Validation</h2>
        <p class="muted">Feed data through the production and validate IRIS + PostgreSQL tables.</p>
      </div>

      <details class="details details--accent">
        <summary>Data Ingestion and Validation</summary>
        <br/>

        <form class="checklist" data-checklist-id="exercise-1-validate">

          <div class="details__content">
            <p class="muted">In this section, we will feed data through the interoperability production and validate that it has populated our tables.</p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="1" />
            <span><strong>1. </strong>At the top of the production page, click Start. Click OK.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="2" />
            <!-- TODO: make these folders -->
            <span><strong>2. </strong>Download these HL7v2 messages: 
              <ul>
                <li>ADT_A01.hl7.txt  <a
                  href="../assets/downloads/ADT_A01.hl7.txt"
                  download
                  target="_blank"
                  class="btn btn--icon"
                  aria-label="Download ADT^A01.hl7.txt"
                  title="Download ADT^A01.hl7.txt"
                >
                  <img
                    src="../assets/images/download.svg"
                    alt=""
                    aria-hidden="true"
                  />
                </a></li>

              <li>ADT_A02.hl7.txt  <a
                href="../assets/downloads/ADT_A02.hl7.txt"
                download
                target="_blank"
                class="btn btn--icon"
                aria-label="Download ADT^A02.hl7.txt"
                title="Download ADT^A02.hl7.txt"
              >
                <img
                  src="../assets/images/download.svg"
                  alt=""
                  aria-hidden="true"
                />
              </a></li>
              <li>ADT_A03.hl7.txt <a
                href="../assets/downloads/ADT_A03.hl7.txt"
                download
                target="_blank"
                class="btn btn--icon"
                aria-label="Download ADT^A03.hl7.txt"
                title="Download ADT^A03.hl7.txt"
              >
                <img
                  src="../assets/images/download.svg"
                  alt=""
                  aria-hidden="true"
                />
              </a></li>
              </ul></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="3" />
            <span><strong>3. </strong>Upload these files to your Google VM (in the <code>/home/&lt;USERNAME&gt;</code> directory).</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="4" />
            <span>
              <strong>4. </strong>From your home directory, copy these files into the <code>/isc/MessageIn/HL7</code> folder, where our interoperability production will ingest the messages:
              <pre><code>cp ADT_A01.hl7.txt /isc/MessageIn/HL7

cp ADT_A02.hl7.txt /isc/MessageIn/HL7

cp ADT_A03.hl7.txt /isc/MessageIn/HL7</code></pre>
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="4" />
            <span>
              <strong>5. </strong>Click on the Messages tab in the right-side settings panel to see messages that flowed through the production. Click on a Session ID to open a visual trace.
              
              <details class="hint">
                <summary>Output</summary>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/35-messages.png" alt="Messages" />
                </div>
                <div class="hint__content">
                  <img src="../assets/images/exercise1/36-visual-trace.png" alt="Visual Trace" />
                </div>
              </details>
            </span>
          </label>

          <div class="details__content">
            <p class="muted">
              We will validate successful data ingestion by querying the data through a built-in SQL engine in IRIS. This will surface data stored in InterSystems IRIS's embedded database.
            </p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="5" />
            <span><strong>6. </strong>From the Home page of the Management Portal, navigate to System Explorer → SQL.</span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="7" />
            <span><strong>7. </strong>In the text box at the center of the page, enter the following query: 
              <pre><code>SELECT * FROM uhtpoc.Patient</code></pre></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="8" />
            <span><strong>8. </strong>Click the Execute button above the query text box.

              You should see that 2 of the 3 patients are now stored in this table (on of them was filtered out by the business rule condition we configured earlier).
            </span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="9" />
            <span><strong>9. </strong>In the text box at the center of the page, enter the following query: 
              <pre><code>SELECT * FROM uhtpoc.Encounter</code></pre>
          </span>

          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="10" />
            <span><strong>10. </strong>Click the Execute button above the query text box.
            
              You should see that all 3 encounters are in this table.
          </label>

          <div class="details__content">
            <p class="muted">Next, we will connect to the external PostgreSQL database to query this data outside of IRIS.</p>
          </div>

          <label class="checklist__item">
            <input type="checkbox" data-step="12" />
            <span><strong>11. </strong>In your VM terminal, run: 
              <pre><code>PGPASSWORD='SYS' psql -h localhost -p 5432 -U superuser -d uhtpoc -c "SELECT * FROM Patient;"</code></pre></span>
          </label>

          <label class="checklist__item">
            <input type="checkbox" data-step="13" />
            <span><strong>12. </strong>In your VM terminal, run: 
            <pre><code>PGPASSWORD='SYS' psql -h localhost -p 5432 -U superuser -d uhtpoc -c "SELECT * FROM Encounter;"</code></pre></span>
          </label>

          <div class="checklist__actions">
            <button class="btn" type="button" data-reset-checklist>Reset section</button>
          </div>
        </form>
      </details>
    </section>
  </main>

  <footer class="footer">
    <div class="container footer__inner">
      <span class="muted">Exercise 1</span>
      <span class="muted">Progress saved locally</span>
    </div>
  </footer>

  <script src="../assets/js/app.js"></script>
</body>
</html>
